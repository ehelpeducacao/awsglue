import sys
from awsglue.transforms import *
from awsglue.utils import getResolvedOptions
from pyspark.context import SparkContext
from awsglue.context import GlueContext
from awsglue.job import Job
from datetime import datetime


args = getResolvedOptions(sys.argv, ['JOB_NAME'])
sc = SparkContext()
glueContext = GlueContext(sc)
spark = glueContext.spark_session
job = Job(glueContext)
job.init(args['JOB_NAME'], args)

data_atual = datetime.now()
ano = data_atual.year
mes = data_atual.month
dia = data_atual.day
mes = f"{mes:02d}"
dia = f"{dia:02d}"

# Lendo dado da landing 
Landing_to_raw_node1715617396190 = glueContext.create_dynamic_frame.from_options(format_options={"quoteChar": "\"", "withHeader": True, "separator": ";", "optimizePerformance": False}, connection_type="s3", format="csv", connection_options={"paths": ["s3://landing-zone-echo/consolidado/Fato_Consolidada.csv"], "recurse": True}, transformation_ctx="Landing_to_raw_node1715617396190")

# Renomear_campos
Renomear_campos_node1715618033910 = ApplyMapping.apply(frame=Landing_to_raw_node1715617396190, mappings=[("negócio", "string", "negocio", "string"),  ("unidade de negócio", "string", "unidade_de_negocio", "string"),  ("origem da operação", "string", "origem_da_operacao", "string"),  ("prazo", "string", "prazo", "string"),  ("natureza de operação", "string", "natureza_de_operacao", "string"),  ("tipo de operação", "string", "tipo_de_operacao", "string"),  ("data acordo comercial", "string", "dt_acordo_comercial", "string"),  ("`início do forn. novo`", "string", "inicio_do_fom_novo", "string"),  ("`fim do forn. novo`", "string", "fim do_fom_novo", "string"),  ("submercado", "string", "submercado", "string"),  ("fonte de energia", "string", "fonte_de_energia", "string"),  ("retusd / spread", "string", "retusd_spread", "string"),  ("cnpj da parte", "string", "cnpj_da_parte", "string"),  ("empresa responsável", "string", "empresa_responsavel", "string"),  ("cnpj da contraparte", "string", "cnpj_da_contraparte", "string"),  ("tipo de documento", "string", "tipo_de_documento", "string"),  ("negociante", "string", "negociante", "string"),  ("flexibilidade de preço", "string", "flexibilidade_de_preco", "string"),  ("preço base contratado", "string", "preco_base_contratado", "string"),  ("ágio", "string", "agio", "string"),  ("`desconto egv (%)`", "string", "desconto_egv_perc", "string"),  ("índice de reajuste", "string", "indice_de_reajuste", "string"),  ("data base", "string", "data_base", "string"),  ("data do 1º reajuste", "string", "data_do_1_reajuste", "string"),  ("tipo de volume contratado", "string", "tipo_de_volume_contratado", "string"),  ("mwmed", "string", "mwmed", "string"),  ("mwh", "string", "mwh", "string"),  ("sazonalidade mínima", "string", "sazonalidade_minima", "string"),  ("sazonalidade máxima", "string", "sazonalidade_maxima", "string"),  ("flexibilidade inferior", "string", "flexibilidad_ inferior", "string"),  ("flexibilidade superior", "string", "flexibilidade_superior", "string"),  ("tipo de modulação", "string", "tipo_de_modulacao", "string"),  ("condição de pagamento", "string", "condicao_de_pagamento", "string"),  ("tipo de garantia", "string", "tipo_de_garantia", "string"),  ("valor garantia", "string", "valor_garantia", "string"),  ("número de meses em garantia", "string", "num_de_meses_em_garantia", "string"),  ("data do fornecimento", "string", "data_do_fornecimento", "string"),  ("início do fornecimento", "string", "inicio_do_fornecimento", "string"),  ("fim do fornecimento", "string", "fim_do_fornecimento", "string"),  ("pld", "string", "pld", "string"),  ("classificação", "string", "classificacao", "string"),  ("observações", "string", "observacoes", "string"),  ("tipo", "string", "tipo", "string"),  ("mwh sazonalizado", "string", "mwh_sazonalizado", "string"),  ("`nome ucs (se tiver)`", "string", "nome_ucs_se_tiver", "string"),  ("`cnpj ucs (se tiver)`", "string", "cnpj_ucs_se_tiver", "string"),  ("cliente no pipefy?", "string", "cliente_no_pipefy", "string"),  ("código da proposta", "string", "codigo_da_proposta", "string"),  ("`número da boleta (thunders)`", "string", "numero_da_boleta_thunders", "string"),  ("nome da empresa / razão social", "string", "nome_empresa_razao_social", "string"),  ("documento do cliente", "string", "documento_do_cliente", "string"),  ("cnpj", "string", "cnpj", "string"),  ("cpf do cliente", "string", "cpf_cliente", "string"),  ("nome do cliente", "string", "nome_do_cliente", "string"),  ("telefone do cliente", "string", "telefone_cliente", "string"),  ("email do cliente", "string", "email_cliente", "string"),  ("distribuidora", "string", "distribuidora", "string"),  ("grupo de tensão - matriz", "string", "grupo_tensao_matriz", "string"),  ("modalidade tarifária - matriz", "string", "modalidade_tarifaria_matriz", "string"),  ("`demanda ponta livre (kw) - matriz`", "string", "demanda_ponta_livre_kw", "string"),  ("`demanda fora ponta livre (kw) - matriz`", "string", "demanda_fora_ponta_livre_kw", "string"),  ("`consumo médio mensal ponta (kwh) - matriz`", "string", "consumo_medio_mensal_ponta_kwh_matriz", "string"),  ("`consumo médio mensal fora ponta (kwh) - matriz`", "string", "consumo_medio_mensal_fora_ponta_kwh_matrixz", "string"),  ("digite ou selecione a data de vigência do contrato - matriz", "string", "dt_vigencia_contrato_matriz", "string"),  ("`quantidade de unidades consumidoras (ucs)`", "string", "quant_unidades_consumidoras_ucs", "string"),  ("grupo de tensão - filial 1", "string", "grupo_tensao_filial_1", "string"),  ("modalidade tarifária - filial 1", "string", "modalidade_tariaria_filial_1", "string"),  ("`demanda ponta livre (kw) - filial 1`", "string", "demanda_ponta_livre_kw_filial_1", "string"),  ("`demanda fora ponta livre (kw) - filial 1`", "string", "demanda_fora_ponta_livre_kw_filial_1", "string"),  ("`consumo médio mensal ponta (kwh) - filial 1`", "string", "consumo_medio_mensal_ponta_kwh_filial_1", "string"),  ("`consumo médio mensal fora ponta (kwh) - filial 1`", "string", "consumo_medio_mensal_fora_ponta_kwh_filial_1", "string"),  ("digite ou selecione a data de vigência do contrato - filial 1", "string", "dt_vigencia_filial_1", "string"),  ("grupo de tensão - filial 2", "string", "grupo_tensao_filial_2", "string"),  ("modalidade tarifária - filial 2", "string", "modalidade_tarifaria_filial_2", "string"),  ("`demanda ponta livre (kw) - filial 2`", "string", "demanda_ponta_livre_kw_filial_2", "string"),  ("`demanda fora ponta livre (kw) - filial 2`", "string", "demanda_fora_ponta_livre_kw_filial_2", "string"),  ("`consumo médio mensal ponta (kwh) - filial 2`", "string", "consumo_medio_mensal_ponta_kwh_filial_2", "string"),  ("`consumo médio mensal fora ponta (kwh) - filial 2`", "string", "consumo_medio_mensal_fora_kwh_filial_2", "string"),  ("digite ou selecione a data de vigência do contrato - filial 2", "string", "dt_vigencia_contrato_filial_2", "string"),  ("grupo de tensão - filial 3", "string", "grupo_tensao_filial_3", "string"),  ("modalidade tarifária - filial 3", "string", "modalidade_tarifaria_filial_3", "string"),  ("`demanda ponta livre (kw) - filial 3`", "string", "demanda_ponta_livre_kw_filial_3", "string"),  ("`demanda fora ponta livre (kw) - filial 3`", "string", "demanda_fora_livre_kw_filial_3", "string"),  ("`consumo médio mensal ponta (kwh) - filial 3`", "string", "consumo_medio_mensal_ponta_kwh_filial_3", "string"),  ("`consumo médio mensal fora ponta (kwh) - filial 3`", "string", "consumo_medio_mensal_fora_kwh_filial_3", "string"),  ("digite ou selecione a data de vigência do contrato - filial 3", "string", "dt_vigencia_filial_3", "string"),  ("grupo de tensão - filial 4", "string", "grupo_tensao_filial_4", "string"),  ("modalidade tarifária - filial 4", "string", "modalidade_tarifaria_filial_4", "string"),  ("`demanda ponta livre (kw) - filial 4`", "string", "demanda_ponta_livre_kw_filial_4", "string"),  ("`demanda fora ponta livre (kw) - filial 4`", "string", "demanda_fora_ponta_livre_kw_filial_4", "string"),  ("`consumo médio mensal ponta (kwh) - filial 4`", "string", "consumo_medio_mensal_ponta_kw_filial_4", "string"),  ("`consumo médio mensal fora ponta (kwh) - filial 4`", "string", "consumo_medio_mensal_fora_kw_filial_4", "string"),  ("digite ou selecione a data de vigência do contrato - filial 4", "string", "dt_vigencia_contrato_filial_4", "string"),  ("distribuidora do consultor", "string", "distribuidora_do_consultor", "string"),  ("produto ofertado", "string", "produto_ofertado", "string"),  ("`% de desconto ofertado (economia garantida)`", "string", "perc_desconto_ofertado_econ_garantida`", "string"),  ("`preço médio de venda projetado do produto (economia garantida)`", "string", "preco_medio_venda_projetado_produto_economia_garantida", "string"),  ("`preço médio ponderado ofertado (preço fixo)`", "string", "preco_medio_ponderado_ofertado_preco_fixo", "string"),  ("tipo de cliente", "string", "tipo_cliente", "string"),  ("`% de desconto ofertado (preço fixo)`", "string", "perc_desconto_ofertado_preco_fixo", "string"),  ("número de conta contrato", "string", "num_conta_contrato", "string"),  ("`volume (mwm)`", "string", "volume_mwm", "string"),  ("`produto ofertado (final)`", "string", "produto_ofertado_final", "string"),  ("data de inicio do fornecimento de energia", "string", "dt_inicio_fornecimento_energia", "string"),  ("data de finalização do fornecimento de energia", "string", "dt_finalizacao_fornecimento_energia", "string"),  ("dia útil de pagamento", "string", "dia_util_pagamento", "string"),  ("razão social da contraparte", "string", "razao_social_contraparte", "string"),  ("data de início de fornecimento", "string", "dt_inicio_fornecimento", "string"),  ("data fim de fornecimento", "string", "dt_fim_forncedimento", "string"),  ("`volume (mwm e mwmed)`", "string", "volume_mwm_e_mwmed", "string"),  ("nº do contrato", "string", "num_do_contrato", "string"),  ("ok / nok / sanitizado", "string", "ok_nok_sanitizado", "string")], transformation_ctx="Renomear_campos_node1715618033910")

#Sink
Sink_raw_node1715617615143 = glueContext.write_dynamic_frame.from_options(frame=Renomear_campos_node1715618033910, connection_type="s3", format="glueparquet", connection_options={"path": f"s3://raw-zone-echo/consolidado_snapshot/{ano}/{mes}/{dia}/", "partitionKeys": [], "mode": "overwrite"}, format_options={"compression": "snappy"}, transformation_ctx="Sink_raw_node1715617615143")

job.commit()
